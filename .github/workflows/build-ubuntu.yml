name: Build Ubuntu

on:
  push:
    tags:
      - 'gcc*-kos*'
  workflow_dispatch:
    inputs:
      gcc_version:
        description: 'GCC version (e.g., 15.1.0) - Leave empty to use default'
        required: false
        type: string
      kos_version:
        description: 'KallistiOS version tag (e.g., v2.2.1) - Leave empty to use default'
        required: false
        type: string

# Configuration: Edit these to change default versions
env:
  DEFAULT_GCC_VERSION: '15.1.0'
  DEFAULT_KOS_VERSION: 'v2.2.1'

jobs:
  build-ubuntu:
    name: Build on Ubuntu
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Required to create releases and upload assets

    env:
      TOOLCHAIN_PATH: /opt/toolchains/dc

    steps:
      # Determine versions from tag, input, or defaults
      - name: Set versions
        id: version
        run: |
          # Extract versions from tag format: gcc15.1.0-kos2.2.1 or gcc15.1.0-kosv2.2.1
          if [[ "${{ github.event_name }}" == "push" && "$GITHUB_REF_NAME" =~ gcc([0-9]+\.[0-9]+\.[0-9]+)-kos(v?)([0-9]+\.[0-9]+\.[0-9]+) ]]; then
            echo "gcc_version=${BASH_REMATCH[1]}" >> $GITHUB_OUTPUT
            KOS_VER="${BASH_REMATCH[2]}${BASH_REMATCH[3]}"  # Includes 'v' if present
            # Ensure KOS version has 'v' prefix
            if [[ ! "$KOS_VER" =~ ^v ]]; then
              KOS_VER="v${KOS_VER}"
            fi
            echo "kos_version=${KOS_VER}" >> $GITHUB_OUTPUT
            echo "kos_version_short=${BASH_REMATCH[3]}" >> $GITHUB_OUTPUT
          elif [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            # Manual trigger: use inputs or defaults
            if [[ -n "${{ inputs.gcc_version }}" ]]; then
              echo "gcc_version=${{ inputs.gcc_version }}" >> $GITHUB_OUTPUT
            else
              echo "gcc_version=${{ env.DEFAULT_GCC_VERSION }}" >> $GITHUB_OUTPUT
            fi
            if [[ -n "${{ inputs.kos_version }}" ]]; then
              KOS_VER="${{ inputs.kos_version }}"
            else
              KOS_VER="${{ env.DEFAULT_KOS_VERSION }}"
            fi
            echo "kos_version=${KOS_VER}" >> $GITHUB_OUTPUT
            echo "kos_version_short=${KOS_VER#v}" >> $GITHUB_OUTPUT
          else
            # Fallback to defaults
            echo "gcc_version=${{ env.DEFAULT_GCC_VERSION }}" >> $GITHUB_OUTPUT
            KOS_VER="${{ env.DEFAULT_KOS_VERSION }}"
            echo "kos_version=${KOS_VER}" >> $GITHUB_OUTPUT
            echo "kos_version_short=${KOS_VER#v}" >> $GITHUB_OUTPUT
          fi
        shell: bash

      # Checkout the repository code
      - name: Checkout code
        uses: actions/checkout@v4

      # Install dependencies on Ubuntu
      - name: Set up dependencies on Ubuntu
        run: |
          sudo apt-get update
          sudo apt install -y gawk patch bzip2 tar make libgmp-dev libmpfr-dev libmpc-dev gettext wget \
            libelf-dev texinfo bison flex sed git build-essential diffutils curl libjpeg-dev libpng-dev \
            python3 pkg-config cmake libisofs-dev meson ninja-build rake
        shell: bash

      # Create the toolchain directory and download KallistiOS
      - name: Create toolchain directory and download KallistiOS
        run: |
          sudo mkdir -p $TOOLCHAIN_PATH
          sudo chmod -R 755 $TOOLCHAIN_PATH
          sudo chown -R $(id -u):$(id -g) $TOOLCHAIN_PATH
          cd $TOOLCHAIN_PATH
          
          # Use the specified KallistiOS version
          KOS_VERSION="${{ steps.version.outputs.kos_version }}"
          echo "Downloading KallistiOS ${KOS_VERSION}..."
          
          # Download and extract the release tarball
          curl -L "https://github.com/KallistiOS/KallistiOS/archive/refs/tags/${KOS_VERSION}.tar.gz" -o kos.tar.gz
          tar xzf kos.tar.gz
          mv KallistiOS-${KOS_VERSION#v} kos
          rm kos.tar.gz
          
          echo "KallistiOS ${KOS_VERSION} downloaded and extracted"
        shell: bash

      # Configure the toolchain
      - name: Configure the toolchain
        run: |
          cd $TOOLCHAIN_PATH/kos/utils/dc-chain
          cp Makefile.default.cfg Makefile.cfg
          sed -i "s/toolchain_profile=stable/toolchain_profile=${{ steps.version.outputs.gcc_version }}/" Makefile.cfg
          
          # Enable Go language support in Makefile.cfg
          echo 'enable_go=1' >> Makefile.cfg
          
          # Patch scripts/init.mk to disable libgo when Go is enabled
          # libgo (Go runtime) doesn't work for bare-metal Dreamcast
          sed -i '/pass2_languages := $(pass2_languages),go/a\    gcc_pass2_configure_args += --disable-libgo' scripts/init.mk
          
          # Show what we're building
          echo "=== Makefile.cfg contents ==="
          cat Makefile.cfg
          
          echo "=== Checking init.mk for Go configuration ==="
          grep -A5 "enable_go" scripts/init.mk
        shell: bash

      # Build the SH4 toolchain
      - name: Build SH4 Toolchain
        run: |
          cd $TOOLCHAIN_PATH/kos/utils/dc-chain
          
          # Patch the Makefile to use a more reliable mirror and add retry logic
          # Replace ftpmirror.gnu.org with ftp.gnu.org (more stable)
          sed -i 's|ftpmirror\.gnu\.org|ftp.gnu.org|g' Makefile
          
          # Add retry logic for downloads
          export CURL_OPTS="--retry 5 --retry-delay 10 --retry-max-time 300"
          
          # Try to build with retries
          for i in 1 2 3; do
            echo "Attempt $i of 3..."
            if make; then
              echo "Build successful!"
              break
            else
              echo "Build failed, retrying in 30 seconds..."
              sleep 30
            fi
          done
          
          # Verify Go compiler was built
          echo "Verifying toolchain build..."
          if [ ! -f "$TOOLCHAIN_PATH/sh-elf/bin/sh-elf-gccgo" ]; then
            echo "ERROR: sh-elf-gccgo not found! Go support was not built."
            echo "Checking what was built:"
            ls -la $TOOLCHAIN_PATH/sh-elf/bin/
            exit 1
          fi
          echo "‚úÖ sh-elf-gccgo found"
          
          # Clean up dc-chain build artifacts to save space
          echo "Cleaning up dc-chain build artifacts..."
          make clean distclean
          echo "‚úÖ dc-chain cleaned"
        shell: bash

      # Set up KOS environment and build KOS
      - name: Set up KOS environment and build
        run: |
          cd $TOOLCHAIN_PATH/kos
          cp doc/environ.sh.sample environ.sh
          source $TOOLCHAIN_PATH/kos/environ.sh
          export LIBRARY_PATH="/usr/local/lib"
          export CPATH="/usr/local/include"
          
          # Build KOS with error checking
          echo "Building KallistiOS..."
          if ! make; then
            echo "KOS build failed!"
            exit 1
          fi
          
          # Verify critical files exist
          echo "Verifying KOS build..."
          if [ ! -f "$TOOLCHAIN_PATH/kos/lib/dreamcast/libkallisti.a" ]; then
            echo "ERROR: libkallisti.a not found after build!"
            exit 1
          fi
        shell: bash

      # Package the toolchain
      - name: Package toolchain
        run: |
          cd $TOOLCHAIN_PATH
          GCC_VERSION="${{ steps.version.outputs.gcc_version }}"
          KOS_VERSION="${{ steps.version.outputs.kos_version }}"
          
          # Copy license files into the package
          cp $GITHUB_WORKSPACE/LICENSE kos/ || true
          cp $GITHUB_WORKSPACE/NOTICE kos/ || true
          
          # Create tarball with BOTH sh-elf toolchain AND KOS (only lib + include)
          TARBALL="dreamcast-toolchain-gcc${GCC_VERSION}-kos${KOS_VERSION#v}-linux-x86_64.tar.gz"
          
          # Package ONLY what's needed for godc:
          # - sh-elf/ (compilers and GCC libs)
          # - kos/lib/ (compiled KOS libraries)
          # - kos/include/ (KOS headers)
          # - kos/utils/build_wrappers/ (kos-cc wrapper script)
          # - kos/environ*.sh (environment setup)
          # - kos/Makefile.rules (build configuration)
          
          # First, check where libraries are located
          echo "Checking library locations..."
          if [ -d "kos/lib/dreamcast" ]; then
            echo "Libraries found in kos/lib/dreamcast/"
            # Move dreamcast libraries to kos/lib for consistent packaging
            mv kos/lib/dreamcast/* kos/lib/ 2>/dev/null || true
          fi
          
          # Exclude: utils/dc-chain (2.2G), examples (24M), most of kernel source (14M)
          # But include kernel headers which are needed for compilation
          # and essential KOS utilities for C development
          tar czf "$TARBALL" \
            sh-elf/ \
            kos/lib/ \
            kos/include/ \
            kos/kernel/arch/dreamcast/ \
            kos/utils/build_wrappers/ \
            --exclude='*.o' --exclude='*.c' --exclude='*.h' \
            kos/utils/genromfs/genromfs \
            kos/utils/makeip/makeip \
            kos/utils/scramble/scramble \
            kos/environ.sh \
            kos/environ_base.sh \
            kos/environ_dreamcast.sh \
            kos/Makefile.rules \
            kos/LICENSE \
            kos/NOTICE \
            kos/README.md
          
          sha256sum "$TARBALL" > "${TARBALL}.sha256"
          
          mkdir -p $GITHUB_WORKSPACE/release
          mv "$TARBALL" "$GITHUB_WORKSPACE/release/"
          mv "${TARBALL}.sha256" "$GITHUB_WORKSPACE/release/"
        shell: bash

      # Verify the package before uploading
      - name: Verify toolchain package
        run: |
          cd $GITHUB_WORKSPACE/release
          
          # Extract to temp location for verification
          mkdir -p /tmp/verify-toolchain
          tar xzf dreamcast-toolchain-*.tar.gz -C /tmp/verify-toolchain
          
          # Run verification script
          echo "üîç Running verification on packaged toolchain..."
          chmod +x $GITHUB_WORKSPACE/scripts/verify-toolchain.sh
          $GITHUB_WORKSPACE/scripts/verify-toolchain.sh /tmp/verify-toolchain
          
          echo ""
          echo "üß™ Running smoke test..."
          chmod +x $GITHUB_WORKSPACE/scripts/smoke-test.sh
          $GITHUB_WORKSPACE/scripts/smoke-test.sh /tmp/verify-toolchain
          
          # Cleanup
          rm -rf /tmp/verify-toolchain
          
          echo ""
          echo "‚úÖ All verification tests PASSED - Safe to release!"
        shell: bash

      # Upload Release Asset
      - name: Upload Release Asset
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          name: "Dreamcast Toolchain - GCC ${{ steps.version.outputs.gcc_version }} + KallistiOS ${{ steps.version.outputs.kos_version }}"
          files: |
            release/dreamcast-toolchain-*.tar.gz
            release/dreamcast-toolchain-*.sha256
          body: |
            ## Dreamcast Toolchain - GCC ${{ steps.version.outputs.gcc_version }}
            
            Pre-built cross-compilation toolchain for Sega Dreamcast development.
            
            ### Included Components
            - **GCC**: ${{ steps.version.outputs.gcc_version }} with C and Go support
            - **KallistiOS**: ${{ steps.version.outputs.kos_version }} ([release](https://github.com/KallistiOS/KallistiOS/releases/tag/${{ steps.version.outputs.kos_version }}))
            - **Binutils**: Latest compatible version from dc-chain
            
            ### Installation
            ```bash
            # Extract the tarball
            tar xzf dreamcast-toolchain-gcc${{ steps.version.outputs.gcc_version }}-kos${{ steps.version.outputs.kos_version_short }}-linux-x86_64.tar.gz
            export PATH="$PWD/kos/bin:$PATH"
            sh-elf-gcc --version
            ```
            
            ### License Information
            This distribution includes GPL v3 (GCC, Binutils) and BSD-licensed (KallistiOS) components.
            
            **Source Code** (GPL compliance):
            - GCC: https://ftp.gnu.org/gnu/gcc/gcc-${{ steps.version.outputs.gcc_version }}/
            - KallistiOS: https://github.com/KallistiOS/KallistiOS
            - Build scripts: This repository
            
            See LICENSE and NOTICE files included in the distribution for complete details.
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Upload Build Artifacts
      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dreamcast-toolchain-linux-x86_64
          path: |
            release/dreamcast-toolchain-*.tar.gz
            release/dreamcast-toolchain-*.sha256
          retention-days: 30
